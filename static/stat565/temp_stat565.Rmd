---
title: 'STAT565 HW1'
author: "Draft"
date: "Winter 2019"
output: html_document
---


### Problem 1 

In a greenhouse experiment, 5 types of light were used: natural, white, green, blue, and yellow. Eight tobacco plants, each 10 mm tall, were subjected to each type of light with the following means and variances of stem growths (in mm).

|  Color | Natural | White | Yellow | Blue | Green |
|   ---- |    ---  |  ---  |  ----  | ---- | ----  |
|  Mean  | 4.09    |4.30   |3.55    |3.01  |3.19   |
|Variance| 0.027   |0.083  |0.066   |0.030 |0.073  |

A partial ANOVA table was found to be

|Source of Variance|Sum of Squares(SS)|Degrees of Freedom(df)|Mean Squares(MS)|F test statistic|
| ---  | ---  | --- | --- | --- |
|Treatment(Between or Model)|9.95904 |4 |2.48976|44.688|
|Error(Within)              |1.950   |35|0.05571429|   
|Total                      |11.90904      |39|

  (a) Complete the ANOVA table assuming the one-way fixed effects ANOVA model. Show main steps of your work. Keep 3 decimal places in $SS_{Trt}$

For $a=5,n=8$, $SS_T=N-1=5\times8-1=39$, $SS_{Trt}=5-1=4$, $SS_E=N-a=35$

$$\bar y_{..}=\frac{1}a\sum^a_{i=1}\bar y_{i.}=\frac{1}5(4.09+4.30+3.55+3.01+3.19)=3.628$$

$$SS_{Trt}=n\sum^a_{i=1}(\bar y_{i.}竏箪bar y_{..})^2=9.95904$$

$$MS_{Trt}=\frac{SS_{Trt}}{a-1}=\frac{9.95904}4=2.48976$$
$$MS_{E}=\frac{SS_{E}}{N-a}=\frac{1.950}{35}=0.05571429$$

$$F_{0}=\frac{MS_{Trt}}{MS_{E}}=\frac{2.48976}{0.05571429}=44.688$$

```{r, collapse=TRUE}
bar_y_all <- (4.09+4.30+3.55+3.01+3.19)/5
bar_y_all
ss_trt <- 8*((4.09-bar_y_all)^2+(4.30-bar_y_all)^2+(3.55-bar_y_all)^2+(3.01-bar_y_all)^2+(3.19-bar_y_all)^2)
ss_trt
(ss_trt/4)/(1.950/35)
```
 --- 

  (b) Compute the standard error of the difference of two observed treatment means. (that is, compute $se(\bar y _{i.}-\bar y_{j.})$) Show main steps of your work.

$$se(\bar y _{i.}-\bar y_{j.})=\sqrt{\frac{2MSE}n}=\sqrt{\frac{2\times0.05571429}8}=0.1180194$$

```{r, collapse=TRUE}

sqrt(2*1.950/{8*35})

```
 ---

### Problem 2 (3.37/45)

Exercise 3.37. Assume n_i is the number of observations (replications) for the $i^th$ treatment in the one-way ANVOA. Show main steps of work.

Show that the variance of the linear combination $\sum^{a}_{i=1}c_iy_{i.}$ is $ﾏタ2\sum^{a}_{i=1}n_ic_i^2$

This is an unbalanced CRD. For $c_i$ is contrast constants,

$$Var\left[\sum^{a}_{i=1}c_iy_{i.}\right]=\sum^{a}_{i=1}\left[c_i^2Var(\sum^{n_i}_{j=1}y_{ij})\right]=\sum^{a}_{i=1}\left[c_i^2Var(\sum^{n_i}_{i=1}(\mu_i+ﾎｵ_{ij}))\right]=\sum^{a}_{i=1}\left[c_i^2Var(n_i\mu_i+\sum^{n_i}_{j=1}ﾎｵ_{ij})\right]$$

By the assumption for linear combination, $\mu_i$ is a constant. $Var(n_i\mu_i)=0$ and $Var(ﾎｵ_{ij})=\sigma^2$, then the fomula equals

$$=\sum^{a}_{i=1}\left[c_i^2(0+\sum^{n_i}_{j=1}Var(ﾎｵ_{ij}))\right]=\sum^{a}_{i=1}\left[c_i^2n_i\sigma^2\right]=ﾏタ2\sum^{a}_{i=1}n_ic_i^2$$

 ---

### Problem 3

Let $y_{ij}=\mu+\tau_{i}+\varepsilon_{ij}, ﾎｵ_{ij}\sim iid\ N(0,ﾏタ2)$,for $i=1,2,窶ｦ,a;\ j=1,2,窶ｦ,n$;$\sum_{i=1}^a\tau_i=0$, $\bar y_{i.}=\frac1n \sum_{j=1}^ny_{ij}$, $\bar y_{i.}\sim iid\ N(\mu+\tau_i,\frac{\sigma^2}n)$

  (a) Using ONLY the above given information and properties of expected value of a function of random variables, derive (DO NOT use any other distribution properties)

$$E(y_{ij}-\bar y_{i.})=E[\mu+\tau_{i}+\varepsilon_{ij}-\frac1n \sum_{j=1}^n(\mu+\tau_{i}+\varepsilon_{ij})]$$

For a fixed effects model, $\mu$ is a constant and $\tau_i$ is a constant of the $i^{th}$ treatment, then

$$=E[\mu+\tau_{i}-\mu-\tau_{i}+\varepsilon_{ij}-\frac1n \sum_{j=1}^n{\varepsilon_{ij}}]=E[\varepsilon_{ij}-\frac1n \sum_{j=1}^n\varepsilon_{ij}]$$

For $ﾎｵ_{ij}\sim iid\ N(0,ﾏタ2)$, $E[\varepsilon_{ij}]=0$, then

$$E(y_{ij}-\bar y_{i.})=E[\varepsilon_{ij}]-\frac1n \sum_{j=1}^n{E[\varepsilon_{ij}]}=0$$

$$Var(y_{ij}-\bar y_{i.})=Var[\mu+\tau_{i}+\varepsilon_{ij}-\frac1n \sum_{j=1}^n{(\mu+\tau_{i}+\varepsilon_{ij})}]=Var[\varepsilon_{ij}-\frac1n \sum_{j=1}^n\varepsilon_{ij}]$$
$$=Var[\varepsilon_{ij}]+\frac1{n^2}\sum_{j=1}^nVar[\varepsilon_{ij}]-2Cov[\varepsilon_{ij},\sum_{j=1}^n\varepsilon_{ij}]=Var[\varepsilon_{ij}]+\frac{Var[\varepsilon_{ij}]}n-2Cov[\varepsilon_{ij},(\varepsilon_{i1}+..+\varepsilon_{ij}..+\varepsilon_{in})]$$

$$Cov[\varepsilon_{ij},(\varepsilon_{i1}+..+\varepsilon_{ij}..+\varepsilon_{in})]=Cov[\varepsilon_{ij},\varepsilon_{i1}]+..+Cov[\varepsilon_{ij},\varepsilon_{ij}]..+Cov[\varepsilon_{ij},\varepsilon_{in}]$$

For $ﾎｵ_{ij}\sim iid\ N(0,ﾏタ2)$, $Var[\varepsilon_{ij}]=Cov[\varepsilon_{ij},\varepsilon_{ij}]=\sigma^2$, $Cov[\varepsilon_{ij},\varepsilon_{ik}]=0,k=1,2,..n$ then

$$Var(y_{ij}-\bar y_{i.})=\sigma^2+\frac{\sigma^2}n-2\sigma^2=\frac{1-n}n\sigma^2$$
 
 ---

  (b) Using your answers in part (a) and shortcut formula for variance ($Var(X)=E(X^2)-E(X)^2$), find 
$E[(y_{ij}-\bar y_{i.})^2]=$

For $Var[y_{ij}-\bar y_{i.}]=E[(y_{ij}-\bar y_{i.})^2]-E[y_{ij}-\bar y_{i.}]^2$, then

$$E[(y_{ij}-\bar y_{i.})^2]=Var[y_{ij}-\bar y_{i.}]+E[y_{ij}-\bar y_{i.}]^2=\frac{1-n}n\sigma^2$$

 ---

  (c) Let $a=3$ treatments in the above model and the following linear functions of $\mu_i=\mu+\tau_i$ are tested. $\mu_1=\mu_2$, $\frac{\mu_1+\mu_2}{2}=\mu_3$.

   (i) Prove that each of these is a contrast and they are orthogonal contrasts.

For $a=3,\mu_1=\mu_2$, $c_1=1,c_2=-1,c_3=0$. For $\frac{\mu_1+\mu_2}2=\mu_3$, $d_1=1,d_2=1,d_3=-2$

$$\sum_{i=1}^3c_i=1-1+0=0;\quad\sum_{i=1}^3d_i=1+1-2=0$$

$$\sum_{i=1}^3c_id_i=1*1+(-1)*1+(-2)*0=0$$

Therefore, they are orthogonal contrasts.

 ---

  (ii) Write Sum of Squares for each contrast $SS_c$ in terms of $y_{1.},y_{2.},y_{3.}$.
    
$$SS_c=\frac{C^2}{\frac1n\sum_{i=1}^ac_i^2}=\frac{(\sum_{i=1}^ac_i\bar y_{i.})^2}{\frac1n\sum_{i=1}^ac_i^2}=\begin{cases}\frac{(\bar y_{1.}-\bar y_{2.})^2}{\frac{1+1}n}
&for\ \mu_1=\mu_2\\
\frac{(\bar y_{1.}+\bar y_{2.}-2\bar y_{3.})^2}{\frac{1+1+4}n}
&for\ \frac{\mu_1+\mu_2}{2}=\mu_3
\end{cases}$$
    
  ---
    
  (iii) Add the two $SS_c$ you found in part (ii) and simplify (expand and bring similar terms together).

$$SS_c=\frac{n(\bar y_{1.}-\bar y_{2.})^2}{2}+\frac{n(\bar y_{1.}+\bar y_{2.}-2\bar y_{3.})^2}{6}=\frac{n}6(4\bar y_{1.}^2+4\bar y_{2.}^2+4\bar y_{3.}^2-4\bar y_{1.}\bar y_{2.}-4\bar y_{2.}\bar y_{3.}-4\bar y_{1.}\bar y_{3.})$$

Then expand and simplify the $SS_{Trt}$ given below to prove that it is equivalent to the sum of two $SS_c$ you found earlier.

$$SS_{Trt}=n\sum_{i=1}^3(\bar y_{i.}-\bar y_{..})^2=\frac{n}9\sum_{i=1}^3(3\bar y_{i.}-\bar y_{1.}-\bar y_{2.}-\bar y_{3.})^2=\frac{n}9[(2\bar y_{1.}-\bar y_{2.}-\bar y_{3.})^2+(2\bar y_{2.}-\bar y_{1.}-\bar y_{3.})^2+(2\bar y_{3.}-\bar y_{1.}-\bar y_{2.})^2]$$
$$=\frac{n}9[6\bar y_{1.}^2+6\bar y_{2.}^2+6\bar y_{3.}^2-6\bar y_{1.}\bar y_{2.}-6\bar y_{2.}\bar y_{3.}-6\bar y_{1.}\bar y_{3.}]$$



$$\therefore SS_c=SS_{Trt}=\frac{2n}3(\bar y_{1.}^2+\bar y_{2.}^2+\bar y_{3.}^2-\bar y_{1.}\bar y_{2.}-\bar y_{2.}\bar y_{3.}-\bar y_{1.}\bar y_{3.})$$


### Problem 4 (3.26/30)

Use software to do all the computations, and attach code and output at the end of the question.
If your answers rely on graphs, please include them along with the answer appropriately
Report p-value along with your conclusions
Data are given in Exercise3_26 Excel file .

Three brands of batteries are under study. It is suspected that the lives (in weeks) of the three brands are different. Five randomly selected batteries of each brand are tested with the following results:

```{r include=FALSE}
library(readxl)
library(tidyverse)
require(ggplot2)
library(car)
library(olsrr)

library(vcd)
library(vcdExtra)
library(multcompView)
library(agricolae)
library(asbio)
```

  (a) Are the lives of these brands of batteries different?
  
```{r echo=T, collapse=TRUE}
table_battery <- read_xlsx("Exercise3_26.xlsx")
model_battery <- aov(Life~Brand, data=table_battery)
anova(model_battery)
summary(model_battery)
ols_regress(Life~Brand, table_battery)
```
  
  (b) Analyze the residuals from this experiment.

```{r echo=T}
ols_plot_diagnostics(lm(Life~Brand, data=table_battery))
ols_test_normality(lm(Life~Brand, data=table_battery))

```
  
  (c) Construct a 95 percent confidence interval estimate on the mean life of battery brand 2. Construct a 99 percent confidence interval estimate on the mean difference between the lives of battery brands 2 and 3.
  
```{r echo=T}
confint(model_battery, level = 0.95)

(LSD.test(model_battery, trt="Brand"))

pairw.anova(table_battery$Life,as.factor(table_battery$Brand), conf.level = 0.99, method = "tukey", MSE = NULL, df.err = NULL, control = NULL)
lsdCI(table_battery$Life,as.factor(table_battery$Brand), conf.level = 0.99, MSE = NULL, df.err = NULL)
bonfCI(table_battery$Life,as.factor(table_battery$Brand), conf.level = 0.99, MSE = NULL, df.err = NULL)
tukeyCI(table_battery$Life,as.factor(table_battery$Brand), conf.level = 0.99, MSE = NULL, df.err = NULL)
scheffeCI(table_battery$Life,as.factor(table_battery$Brand), conf.level = 0.99, MSE = NULL, df.err = NULL)
dunnettCI(table_battery$Life,as.factor(table_battery$Brand), conf.level = 0.99, control = NULL)
scheffe.cont(table_battery$Life,as.factor(table_battery$Brand), lvl = c("Brand2", "Brand3"), conf.level = 0.99, MSE = NULL, df.err = NULL)
bonf.cont(table_battery$Life,as.factor(table_battery$Brand), lvl = c("Brand2", "Brand3"), conf.level = 0.99, MSE = NULL, df.err = NULL, comps = 1)


``` 
  
  (d) Which brand would you select for use? If the manufacturer will replace without charge any battery that fails in less than 85 weeks, what percentage would the company expect to replace?


```{r echo=T, collapse=TRUE}

power.anova.test(groups = NULL, n = NULL,between.var = NULL, within.var = NULL, sig.level = 0.05, power = NULL)

```

### Problem 5 (3.22/26)

The response time in milliseconds was determined for three different types of circuits that could be used in an automatic valve shutoff mechanism. The results from a completely randomized experiment are shown in the following table:

  (a) Test the hypothesis that the three circuit types have the same response time. Use 撥ｼ = 0.01.


```{r echo=T, collapse=TRUE}
table_circuit <- read_xlsx("Exercise3_22.xlsx")
model_circuit <- aov(Respone~Type, data=table_circuit)
anova(model_circuit)
```
  
  (b) Use Tukey窶冱 test to compare pairs of treatment means. Use 撥ｼ = 0.01.

```{r echo=T, collapse=TRUE}
# Tukey test to study each pair of treatment :
TukeyHSD(aov(model_circuit), ordered = TRUE,conf.level=0.99)

pairw.anova(table_circuit$Respone,as.factor(table_circuit$Type), conf.level = 0.99, method = "tukey", MSE = NULL, df.err = NULL, control = NULL)
tukeyCI(table_battery$Life,as.factor(table_battery$Brand), conf.level = 0.99, MSE = NULL, df.err = NULL)

HSD.test(model_circuit,"Type", group=TRUE,console=TRUE)

```
  
  (d) Construct a set of orthogonal contrasts, assuming that at the outset of the experiment you suspected the response time of circuit type 2 to be different from the other two.

$$\begin{cases}H_0:\mu_1-2\mu_2+\mu_3=0\\H_1:\mu_1-2\mu_2+\mu_3\neq0\end{cases}$$
$$C_1:y_1-2y_2+y_3=54-2(111)+42=-126$$
  (e) If you were the design engineer and you wished to minimize the response time, which circuit type would you select?
  
  (f) Analyze the residuals from this experiment. Are the basic analysis of variance assumptions satisfied?

### Problem 6: (3.41/9 and 3.49/57)

  (3.41/9) Refer to Problem 5. If we wish to detect a maximum difference in mean response times of 10 milliseconds with a probability of at least 0.90, what sample size should be used? How would you obtain a preliminary estimate of $ﾏタ2$?


 ---
 
  (3.49/57) Consider the data shown in Problem 5.

  (a) Write out the least squares normal equations for this problem and solve them for $\hat\mu$ and $\hat\tau_i$, using the usual constraint ($\sum^3_{i=1} \hat\tau_i=0$). Estimate $\tau_1-\tau_2$

$$\begin{matrix}
15\hat\mu&+5\hat\tau_1&+5\hat\tau_2&+5\hat\tau_3&=207\\
5\hat\mu&+5\hat\tau_1& & &=54\\
5\hat\mu& &+5\hat\tau_2& &=111\\
15\hat\mu& & &+5\hat\tau_3&=42
\end{matrix}$$

For $\sum^3_{i=1} \hat\tau_i=0$, $\hat\mu=13.80,\hat\tau_1=-3.00,\hat\tau_2=8.40,\hat\tau_3=-5.40$

$\hat\tau_1-\hat\tau_2=-3.00-8.40=-11.40$

  (b) Solve the equations in (a) using the constraint $\hat\tau_3=0$. Are the estimator $\hat\tau_i$ and $\hat\mu$ the same as you found in (a)? Why? Now estimate $\tau_1-\tau_2$ and compare your answer with that for (a). What statement can you make about estimating contrasts in the $\tau_i$
  
  (c) Estimate $\mu+\tau_1$, $2\tau_1-\tau_2-\tau_3$, $\mu+\tau_1+\tau_2$ and using the two solutions to the normal equations. Compare the results obtained in each case.
  
  
```{r, eval=FALSE, echo=T}

ggplot(table_battery, aes(x = Brand, y = Life)) + geom_boxplot()

prop.table(xtabs(~Life+Brand,data=table_battery,subset=!is.na(Brand), drop.unused.levels=T), 2)

chisq.test(xtabs(~Brand+Life,data=table_battery,subset=!is.na(Life)))

GKgamma(xtabs(~Respone + Type,data=table_circuit,subset=!is.na(Type), drop.unused.levels=T))
#running Leven's Equality of Variance
leveneTest(Life ~ Brand, data = table_battery,center = "mean")

```

